name: SCP Test Deploy

on:
    push:
        branches:
            - working

jobs:
    pandoc:
        runs-on: ubuntu-latest
        name: Pandoc
        container:
            image: docker://pandoc/core:2.9
            options: --entrypoint=sh
        steps:
        - name: Check out code
          uses: actions/checkout@v4
        - name: Markdown to Html
          run: |
            mkdir -p output
            find ./amanasie_simple/ -name '*.md' -type f | while read -r line; do
              HTML_OLD_PATH=${line/.md/.html}
              HTML_OUTPUT_PATH=${MD_OLD_PATH/amanasie_simple/output}
              echo ${HTML_OUTPUT_PATH}
              echo ${line}
              pandoc -f markdown -t html -o ${HTML_OUTPUT_PATH} ${line}
            done
        - name: Upload html
          uses: actions/upload-artifact@v4
          with:
            name: pandoc-html
            path: output
    build:
        runs-on: ubuntu-latest
        name: Build
        needs: pandoc
        steps:
        - name: Check out code
          uses: actions/checkout@v4
        - name: Download html
          uses: actions/download-artifact@v4
          with:
            name: pandoc-html
            path: downloaded
        - name: SCP Deploy
          uses: appleboy/scp-action@v0.1.7
          with:
            key: ${{ secrets.SK }}
            port: ${{ secrets.SSH_PORT }}
            username: ${{ secrets.SSH_USERNAME }}
            host: ${{ secrets.SSH_HOST }}
            source: 'downloaded/*'
            target: '~/www/test'
